generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// User model for authentication (invite-only)
model User {
  id          String   @id @default(cuid())
  email       String   @unique
  password    String?  // Null until user sets their password
  name        String?
  inviteToken String?  @unique // Token for setting password
  invitedAt   DateTime @default(now())
  createdAt   DateTime? // Set when user completes signup
  updatedAt   DateTime @updatedAt

  // User's data
  searches        Search[]
  savedSearches   SavedSearch[]
  savedItems      SavedItem[]
  apiKeys         ApiKey[]
  youtubeConfig   YouTubeConfig?
  repurposeVideos RepurposeVideo[]
  scripts         Script[]
  settings        UserSettings?

  @@index([email])
  @@index([inviteToken])
}

// Platform enum
enum Platform {
  youtube
  instagram
  tiktok
}

// Search history - stores user searches
model Search {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  query     String
  platform  Platform
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Results from this search
  results SearchResult[]

  @@index([userId])
  @@index([platform])
  @@index([createdAt])
}

// Search results - cached results from API calls
model SearchResult {
  id          String   @id @default(cuid())
  searchId    String
  search      Search   @relation(fields: [searchId], references: [id], onDelete: Cascade)

  // Common fields across platforms
  externalId  String   // YouTube video ID, Instagram post ID, TikTok video ID
  platform    Platform
  title       String
  description String?  @db.Text
  thumbnail   String?
  url         String

  // Creator/Channel info
  creatorId   String?
  creatorName String?

  // Stats
  viewCount   BigInt?
  likeCount   BigInt?
  commentCount BigInt?

  // Dates
  publishedAt DateTime?
  createdAt   DateTime @default(now())

  @@unique([searchId, externalId])
  @@index([platform])
  @@index([externalId])
}

// Saved searches - user bookmarked searches with full data
model SavedSearch {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  query     String
  platform  Platform
  createdAt DateTime @default(now())

  // Saved results
  results SavedSearchResult[]

  @@unique([userId, query, platform])
  @@index([userId])
  @@index([platform])
  @@index([createdAt])
}

// Saved search results - stores the actual data from when search was saved
model SavedSearchResult {
  id            String      @id @default(cuid())
  savedSearchId String
  savedSearch   SavedSearch @relation(fields: [savedSearchId], references: [id], onDelete: Cascade)

  // Video data
  externalId   String
  title        String
  creatorName  String
  thumbnail    String?
  url          String
  viewCount    BigInt      @default(0)
  likeCount    BigInt      @default(0)
  commentCount BigInt      @default(0)

  @@index([savedSearchId])
}

// Saved items - individual videos/posts saved by user
model SavedItem {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  externalId  String
  platform    Platform
  title       String
  description String?  @db.Text
  thumbnail   String?
  url         String
  creatorId   String?
  creatorName String?
  viewCount   BigInt?
  likeCount   BigInt?
  commentCount BigInt?
  publishedAt DateTime?
  savedAt     DateTime @default(now())

  @@unique([userId, externalId, platform])
  @@index([userId])
  @@index([platform])
  @@index([savedAt])
}

// API Keys - stores encrypted API keys for different services per user
model ApiKey {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  service   String   // e.g., "youtube", "rapidapi"
  key       String   // encrypted API key
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, service])
  @@index([userId])
  @@index([service])
}

// YouTube search configuration per user
model YouTubeConfig {
  id           String   @id @default(cuid())
  userId       String   @unique
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  maxResults   Int      @default(25) // 1-50
  dateRange    String   @default("any") // any, day, week, month
  region       String   @default("US") // ISO 3166-1 alpha-2 country code
  videoDuration String  @default("any") // any, short (< 4min), medium, long (> 20min)
  order        String   @default("relevance") // date, rating, relevance, title, viewCount
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

// Repurpose videos - videos saved for repurposing
model RepurposeVideo {
  id           String   @id @default(cuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  externalId   String   // YouTube video ID, TikTok video ID, etc.
  platform     Platform
  title        String
  description  String?  @db.Text
  thumbnail    String?
  url          String
  creatorId    String?
  creatorName  String?
  viewCount    BigInt?
  likeCount    BigInt?
  commentCount BigInt?
  publishedAt  DateTime?
  savedAt      DateTime @default(now())

  // Related scripts (transcripts extracted from this video)
  scripts      Script[]

  @@unique([userId, externalId, platform])
  @@index([userId])
  @@index([platform])
  @@index([savedAt])
}

// LLM Models - synced from OpenRouter
model LlmModel {
  id              String   @id @default(cuid())
  modelId         String   @unique // OpenRouter model ID e.g. "openai/gpt-4"
  name            String   // Display name
  provider        String   // Provider name e.g. "OpenAI"
  promptPrice     Float    // Price per 1M tokens (prompt)
  completionPrice Float    // Price per 1M tokens (completion)
  contextLength   Int?     // Max context length
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([provider])
  @@index([modelId])
}

// User Settings - stores user preferences
model UserSettings {
  id              String   @id @default(cuid())
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  selectedModelId String?  // Selected LLM model ID from OpenRouter
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// Scripts - user-created scripts for content
model Script {
  id                String          @id @default(cuid())
  userId            String
  user              User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  title             String
  caption           String?         @db.Text
  script            String          @db.Text // Original transcript
  repurposedScript  String?         @db.Text // AI-rewritten version
  hooks             Json?           // Array of 3 generated hooks
  notes             String?         @db.Text
  status            String          @default("draft") // draft, in_progress, completed
  sourceUrl         String?         // Original video URL if extracted from a video
  repurposeVideoId  String?         // Link to the repurpose video if applicable
  repurposeVideo    RepurposeVideo? @relation(fields: [repurposeVideoId], references: [id], onDelete: SetNull)
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@index([repurposeVideoId])
}
